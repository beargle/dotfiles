version: 1.7.0-{build}
environment:
    DIFF_SO_FANCY_VERSION: 1.2.6
install:
- cmd: git submodule update -q --init
build_script:
- ps: >-
    # stage files (including submodules) in 'archive' directory for artifact creation

    git checkout-index -q -a --prefix="archive/";

    git submodule foreach 'git checkout-index -q -a --prefix="$toplevel/archive/$path/"';

    # create bin directory for script(s) to modify diff output in Git Bash

    New-Item -ItemType "Directory" -Path "archive\bin" | Out-Null;

    # script for colorizing diff output in Git Bash

    Invoke-WebRequest -Uri "https://raw.githubusercontent.com/so-fancy/diff-so-fancy/v${env:DIFF_SO_FANCY_VERSION}/third_party/build_fatpack/diff-so-fancy" -OutFile "archive\bin\diff-so-fancy";
test_script:
- ps: >-
    # check existence of required directories for zip artifact creation

    ForEach ($RequiredPath in @( "archive", "archive\bin", "archive\.vim" ))

    {

        If (Test-Path -Path $RequiredPath -PathType Container)

        {

            Write-Host "Found required '$($RequiredPath)' path for artifact creation.";

        }

        Else

        {

            Throw "Can't find required '$($RequiredPath)' path for artifact creation. $_";

        }

    }

    # check existence of required diff-so-fancy script version

    If (Select-String -Path "archive\bin\diff-so-fancy" -Pattern "\`$VERSION\s+=\s+""$($env:DIFF_SO_FANCY_VERSION)""")

    {

        Write-Host "Found required diff-so-fancy version $($env:DIFF_SO_FANCY_VERSION).";

    }

    Else

    {

        Throw "Can't find required diff-so-fancy version $($env:DIFF_SO_FANCY_VERSION). $_";

    }

    # check existence of required diff-so-fancy script fatpack version (which includes required DiffHighlight module)

    If (Select-String -Path "archive\bin\diff-so-fancy" -Pattern "'FATPACK'")

    {

        Write-Host "Found required diff-so-fancy packed with 'DiffHighlight' module.";

    }

    Else

    {

        Throw "Can't find required diff-so-fancy packed with 'DiffHighlight' module. $_";

    }
artifacts:
- path: archive
  name: $(appveyor_project_name)-$(appveyor_build_version)
